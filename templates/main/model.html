{% extends "main/layout.html" %}

{% block title %}
Создание объявления - Аренда квартир
{% endblock %}

{% block page_title %}
Создание нового объявления
{% endblock %}

{% block page_subtitle %}
Заполните информацию о квартире для аренды
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center mx-0">
        <div class="col-12 px-3 px-md-4">
            <!-- Хлебные крошки -->
            <nav aria-label="breadcrumb" class="mb-3 mb-md-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'post-list' %}" class="text-decoration-none">Главная</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'change' %}" class="text-decoration-none">Мои объявления</a></li>
                    <li class="breadcrumb-item active">Создание объявления</li>
                </ol>
            </nav>
        </div>
        
        <div class="col-12 col-xl-10 px-3 px-md-4">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-primary text-white py-3 py-md-4">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                        <div>
                            <h3 class="mb-1 fs-4 fs-md-3">
                                <i class="fas fa-plus-circle me-2"></i>
                                Новое объявление
                            </h3>
                            <p class="mb-0 opacity-75 fs-6">Заполните все поля для публикации объявления</p>
                        </div>
                        <div class="badge bg-white text-primary fs-6 fs-md-6 p-2 p-md-3">
                            <i class="fas fa-home me-1"></i>
                            Аренда квартиры
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-3 p-md-4">
                    <!-- Прогресс-бар -->
                    <div class="mb-4 mb-md-5">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted fw-semibold fs-6">Прогресс заполнения:</span>
                            <span class="text-primary fw-bold fs-6" id="progressText">0%</span>
                        </div>
                        <div class="progress" style="height: 8px; border-radius: 4px;">
                            <div id="formProgress" class="progress-bar bg-gradient-primary" 
                                 role="progressbar" style="width: 0%; border-radius: 4px;"></div>
                        </div>
                    </div>

                    {% if messages %}
                    <div class="messages mb-4">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if form.errors %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Ошибка заполнения формы!</strong> Пожалуйста, проверьте введенные данные.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}

                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate id="postForm">
                        {% csrf_token %}
                        
                        <!-- Шаг 1: Основная информация -->
                        <div class="form-section mb-4 mb-md-5">
                            <div class="section-header mb-3 mb-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="section-number bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 35px; height: 35px; font-size: 0.9rem;">1</div>
                                    <h4 class="mb-0 text-primary fs-5 fs-md-4">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Основная информация
                                    </h4>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-12 col-md-8">
                                    <label for="id_title" class="form-label fw-semibold fs-6">
                                        <i class="fas fa-heading me-2 text-primary"></i>Заголовок объявления *
                                    </label>
                                    <input type="text" 
                                           name="title" 
                                           id="id_title" 
                                           class="form-control {% if form.title.errors %}is-invalid{% endif %}" 
                                           value="{{ form.title.value|default:'' }}" 
                                           maxlength="200" 
                                           required
                                           placeholder="Например: Сдам современную 2-комнатную квартиру в центре города">
                                    {% if form.title.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.title.errors %}
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text text-muted fs-7">
                                        <small>Придумайте яркий и информативный заголовок</small>
                                    </div>
                                </div>

                                <div class="col-12 col-md-4">
                                    <label for="id_category" class="form-label fw-semibold fs-6">
                                        <i class="fas fa-tag me-2 text-primary"></i>Категория *
                                    </label>
                                    <select name="category" 
                                            id="id_category" 
                                            class="form-select {% if form.category.errors %}is-invalid{% endif %}" 
                                            required>
                                        <option value="">Выберите категорию</option>
                                        {% for category in categories %}
                                        <option value="{{ category.id }}" 
                                                {% if form.category.value == category.id %}selected{% endif %}>
                                            {{ category.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% if form.category.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.category.errors %}
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mt-3 mt-md-4">
                                <label for="id_description" class="form-label fw-semibold fs-6">
                                    <i class="fas fa-align-left me-2 text-primary"></i>Подробное описание квартиры *
                                </label>
                                <textarea name="description" 
                                          id="id_description" 
                                          class="form-control {% if form.description.errors %}is-invalid{% endif %}" 
                                          rows="5" 
                                          required
                                          placeholder="Опишите подробно вашу квартиру:
• Состояние ремонта
• Наличие мебели и техники
• Район и инфраструктуру
• Условия аренды
• Особенности и преимущества">{{ form.description.value|default:'' }}</textarea>
                                {% if form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.description.errors %}
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="form-text text-muted fs-7">
                                        <small>Чем подробнее описание, тем больше откликов</small>
                                    </div>
                                    <div class="form-text fs-7">
                                        <span id="charCount" class="fw-bold">0</span>/2000 символов
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Шаг 2: Изображения -->
                        <div class="form-section mb-4 mb-md-5">
                            <div class="section-header mb-3 mb-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="section-number bg-warning text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 35px; height: 35px; font-size: 0.9rem;">2</div>
                                    <h4 class="mb-0 text-warning fs-5 fs-md-4">
                                        <i class="fas fa-images me-2"></i>
                                        Изображения квартиры
                                    </h4>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="id_images" class="form-label fw-semibold fs-6">
                                    <i class="fas fa-camera me-2 text-warning"></i>Загрузите фотографии
                                </label>
                                <input type="file" 
                                       name="images" 
                                       id="id_images" 
                                       class="form-control {% if form.images.errors %}is-invalid{% endif %}" 
                                       multiple 
                                       accept="image/*">
                                {% if form.images.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.images.errors %}
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="form-text text-muted fs-7">
                                    <small>Можно выбрать несколько файлов (JPG, PNG, WebP). Максимальный размер: 5MB на файл</small>
                                </div>
                            </div>

                            <!-- Preview area -->
                            <div id="imagePreview" class="row g-2 mt-3" style="display: none;">
                                <div class="col-12">
                                    <h6 class="text-muted mb-2 fs-6">Предпросмотр:</h6>
                                </div>
                            </div>
                        </div>

                        <!-- Шаг 3: Характеристики -->
                        <div class="form-section mb-4 mb-md-5">
                            <div class="section-header mb-3 mb-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="section-number bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 35px; height: 35px; font-size: 0.9rem;">3</div>
                                    <h4 class="mb-0 text-success fs-5 fs-md-4">
                                        <i class="fas fa-home me-2"></i>
                                        Характеристики квартиры
                                    </h4>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-12 col-md-4">
                                    <label for="id_price" class="form-label fw-semibold fs-6">
                                        <i class="fas fa-ruble-sign me-2 text-success"></i>Цена в месяц *
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0 py-2">
                                            <i class="fas fa-money-bill-wave text-success"></i>
                                        </span>
                                        <input type="number" 
                                               name="price" 
                                               id="id_price" 
                                               class="form-control py-2 {% if form.price.errors %}is-invalid{% endif %}" 
                                               value="{{ form.price.value|default:'' }}" 
                                               min="1000" 
                                               step="1000" 
                                               required
                                               placeholder="25000">
                                        <span class="input-group-text bg-light py-2">₽/месяц</span>
                                    </div>
                                    {% if form.price.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.price.errors %}
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text text-muted fs-7">
                                        <small>Рекомендуемая цена от 1000 рублей</small>
                                    </div>
                                </div>

                                <div class="col-12 col-md-4">
                                    <label for="id_area" class="form-label fw-semibold fs-6">
                                        <i class="fas fa-expand-arrows-alt me-2 text-success"></i>Площадь (м²) *
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0 py-2">
                                            <i class="fas fa-ruler-combined text-success"></i>
                                        </span>
                                        <input type="number" 
                                               name="area" 
                                               id="id_area" 
                                               class="form-control py-2 {% if form.area.errors %}is-invalid{% endif %}" 
                                               value="{{ form.area.value|default:'' }}" 
                                               min="10" 
                                               step="0.1" 
                                               required
                                               placeholder="45.5">
                                        <span class="input-group-text bg-light py-2">м²</span>
                                    </div>
                                    {% if form.area.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.area.errors %}
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text text-muted fs-7">
                                        <small>Общая площадь квартиры</small>
                                    </div>
                                </div>

                                <div class="col-12 col-md-4">
                                    <label for="id_rooms" class="form-label fw-semibold fs-6">
                                        <i class="fas fa-bed me-2 text-success"></i>Количество комнат *
                                    </label>
                                    <select name="rooms" 
                                            id="id_rooms" 
                                            class="form-select py-2 {% if form.rooms.errors %}is-invalid{% endif %}" 
                                            required>
                                        <option value="">Выберите количество</option>
                                        <option value="1" {% if form.rooms.value == '1' %}selected{% endif %}>1 комната</option>
                                        <option value="2" {% if form.rooms.value == '2' %}selected{% endif %}>2 комнаты</option>
                                        <option value="3" {% if form.rooms.value == '3' %}selected{% endif %}>3 комнаты</option>
                                        <option value="4" {% if form.rooms.value == '4' %}selected{% endif %}>4 комнаты</option>
                                        <option value="5" {% if form.rooms.value == '5' %}selected{% endif %}>5+ комнат</option>
                                    </select>
                                    {% if form.rooms.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.rooms.errors %}
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Шаг 4: Контактная информация -->
                        <div class="form-section mb-4 mb-md-5">
                            <div class="section-header mb-3 mb-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="section-number bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 35px; height: 35px; font-size: 0.9rem;">4</div>
                                    <h4 class="mb-0 text-info fs-5 fs-md-4">
                                        <i class="fas fa-phone me-2"></i>
                                        Контактная информация
                                    </h4>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-12 col-md-6">
                                    <label for="id_address" class="form-label fw-semibold fs-6">
                                        <i class="fas fa-map-marker-alt me-2 text-info"></i>Адрес квартиры *
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0 py-2">
                                            <i class="fas fa-map-pin text-info"></i>
                                        </span>
                                        <input type="text" 
                                               name="address" 
                                               id="id_address" 
                                               class="form-control py-2 {% if form.address.errors %}is-invalid{% endif %}" 
                                               value="{{ form.address.value|default:'' }}" 
                                               maxlength="300" 
                                               required
                                               placeholder="г. Москва, ул. Примерная, д. 123, кв. 45">
                                    </div>
                                    {% if form.address.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.address.errors %}
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text text-muted fs-7">
                                        <small>Полный адрес с городом, улицей, домом и квартирой</small>
                                    </div>
                                </div>

                                <div class="col-12 col-md-6">
                                    <label for="id_contact_phone" class="form-label fw-semibold fs-6">
                                        <i class="fas fa-mobile-alt me-2 text-info"></i>Контактный телефон *
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0 py-2">
                                            <i class="fas fa-phone text-info"></i>
                                        </span>
                                        <input type="tel" 
                                               name="contact_phone" 
                                               id="id_contact_phone" 
                                               class="form-control py-2 {% if form.contact_phone.errors %}is-invalid{% endif %}" 
                                               value="{{ form.contact_phone.value|default:'' }}" 
                                               maxlength="20" 
                                               required
                                               placeholder="+7 (999) 999-99-99">
                                    </div>
                                    {% if form.contact_phone.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.contact_phone.errors %}
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ error }} 
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text text-muted fs-7">
                                        <small>Телефон для связи с потенциальными арендаторами</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Действия -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-stretch align-items-md-center gap-3 mt-4 mt-md-5 pt-4 border-top">
                            <div class="order-2 order-md-1">
                                <a href="{% url 'change' %}" class="btn btn-outline-secondary w-100 w-md-auto">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Вернуться к списку
                                </a>
                            </div>
                            
                            <div class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto order-1 order-md-2">
                                <button type="button" class="btn btn-outline-warning flex-fill" id="saveDraftBtn">
                                    <i class="fas fa-save me-2"></i>
                                    Сохранить черновик
                                </button>
                                <button type="submit" class="btn btn-primary flex-fill px-3 px-md-5" id="submitBtn">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    Опубликовать объявление
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="card-footer bg-light py-3 py-md-4">
                    <div class="row align-items-center">
                        <div class="col-12 col-md-8 mb-3 mb-md-0">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle p-2 me-3">
                                    <i class="fas fa-lightbulb text-white"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 fs-6">Советы по заполнению</h6>
                                    <p class="mb-0 text-muted small fs-7">
                                        Добавляйте качественные фотографии и подробные описания для лучшего отклика
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4 text-center text-md-end">
                            <small class="text-muted fs-7">
                                <i class="fas fa-shield-alt me-1 text-primary"></i>
                                Ваши данные защищены
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border-radius: 15px;
    margin-top: 1rem;
    border: none;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.form-section {
    padding: 1.5rem;
    border-radius: 12px;
    background: #f8f9fa;
    border-left: 4px solid #667eea;
}

.section-number {
    font-weight: bold;
}

.border-top {
    border-top-color: rgba(0,0,0,0.1) !important;
}

.input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.progress {
    overflow: visible;
}

.progress-bar {
    position: relative;
    overflow: visible;
    transition: width 0.5s ease;
}

.progress-bar::after {
    content: '';
    position: absolute;
    right: -6px;
    top: -1px;
    width: 12px;
    height: 12px;
    background: #667eea;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 1px #667eea;
}

/* Анимации */
.form-section {
    transition: all 0.3s ease;
}

.form-section:hover {
    transform: translateX(3px);
}

/* Адаптивность */
@media (max-width: 768px) {
    .card-body {
        padding: 1rem !important;
    }
    
    .form-section {
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .section-header {
        margin-bottom: 1rem !important;
    }
    
    .btn {
        padding: 0.75rem 1rem;
    }
    
    .input-group .form-control,
    .input-group .form-select {
        padding: 0.75rem;
    }
}

@media (max-width: 576px) {
    .container-fluid {
        padding-left: 8px;
        padding-right: 8px;
    }
    
    .card-header {
        padding: 1rem !important;
    }
    
    .form-section {
        padding: 0.75rem;
        border-left-width: 3px;
    }
    
    .section-number {
        width: 30px !important;
        height: 30px !important;
        font-size: 0.8rem !important;
    }
    
    h3 {
        font-size: 1.3rem !important;
    }
    
    h4 {
        font-size: 1.1rem !important;
    }
}

/* Preview images */
.preview-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #dee2e6;
}

.preview-item {
    position: relative;
    display: inline-block;
    margin: 5px;
}

.preview-remove {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Улучшения для очень маленьких экранов */
@media (max-width: 360px) {
    .btn {
        font-size: 0.8rem;
        padding: 0.6rem 0.8rem;
    }
    
    .form-control, .form-select {
        font-size: 0.9rem;
    }
    
    .form-text {
        font-size: 0.75rem !important;
    }
}

/* Touch оптимизации */
.btn, .form-control, .form-select {
    -webkit-tap-highlight-color: transparent;
}

.form-control:focus, .form-select:focus {
    transform: scale(1.02);
    transition: all 0.2s ease;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('postForm');
    const progressBar = document.getElementById('formProgress');
    const progressText = document.getElementById('progressText');
    const charCount = document.getElementById('charCount');
    const descriptionField = document.getElementById('id_description');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const submitBtn = document.getElementById('submitBtn');
    const imageInput = document.getElementById('id_images');
    const imagePreview = document.getElementById('imagePreview');

    // Автофокус на заголовок
    document.getElementById('id_title')?.focus();

    // Подсчет символов
    if (descriptionField && charCount) {
        descriptionField.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = length;
            
            if (length < 50) {
                charCount.className = 'fw-bold text-danger';
            } else if (length < 100) {
                charCount.className = 'fw-bold text-warning';
            } else if (length < 1800) {
                charCount.className = 'fw-bold text-success';
            } else {
                charCount.className = 'fw-bold text-danger';
            }
            
            if (length > 2000) {
                this.value = this.value.substring(0, 2000);
                charCount.textContent = '2000';
            }
            
            updateProgress();
        });
    }

    // Preview изображений
    if (imageInput && imagePreview) {
        imageInput.addEventListener('change', function(e) {
            imagePreview.innerHTML = '';
            imagePreview.style.display = 'none';
            
            const files = e.target.files;
            if (files.length > 0) {
                imagePreview.style.display = 'block';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (!file.type.match('image.*')) continue;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item';
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" class="preview-image" alt="Preview">
                            <button type="button" class="preview-remove" data-index="${i}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        imagePreview.appendChild(previewItem);
                        
                        // Удаление превью
                        previewItem.querySelector('.preview-remove').addEventListener('click', function() {
                            previewItem.remove();
                            // Здесь можно добавить логику удаления из FileList
                        });
                    };
                    reader.readAsDataURL(file);
                }
            }
        });
    }

    // Прогресс заполнения
    function updateProgress() {
        const fields = [
            'id_title', 'id_category', 'id_description', 
            'id_price', 'id_area', 'id_rooms', 
            'id_address', 'id_contact_phone'
        ];
        
        let filled = 0;
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                if (field.type === 'select-one') {
                    if (field.value !== '') filled++;
                } else if (field.type === 'textarea') {
                    if (field.value.trim().length >= 50) filled++;
                } else {
                    if (field.value.trim() !== '') filled++;
                }
            }
        });
        
        const progress = Math.round((filled / fields.length) * 100);
        if (progressBar && progressText) {
            progressBar.style.width = progress + '%';
            progressText.textContent = progress + '%';
            
            // Изменение цвета прогресс-бара
            if (progress < 30) {
                progressBar.className = 'progress-bar bg-danger';
            } else if (progress < 70) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-gradient-primary';
            }
        }
    }

    // Обновление прогресса при изменении полей
    const formFields = document.querySelectorAll('input, select, textarea');
    formFields.forEach(field => {
        field.addEventListener('input', updateProgress);
        field.addEventListener('change', updateProgress);
    });

    // Инициализация прогресса
    updateProgress();

    // Валидация перед отправкой
    form?.addEventListener('submit', function(e) {
        const description = document.getElementById('id_description');
        if (description && description.value.trim().length < 50) {
            e.preventDefault();
            alert('Описание должно содержать минимум 50 символов');
            description.focus();
            return;
        }
        
        // Показываем loading state
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Публикация...';
            submitBtn.disabled = true;
        }
    });

    // Touch оптимизации для мобильных
    function initTouchOptimizations() {
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.98)';
            }, { passive: true });
            
            input.addEventListener('touchend', function() {
                this.style.transform = '';
            }, { passive: true });
        });
    }

    // Инициализация
    initTouchOptimizations();
});
</script>
{% endblock %}